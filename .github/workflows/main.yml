name: CI
on: [push, pull_request]

jobs:
  # Shared install and build job
  install:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Cache Next.js build
        uses: actions/cache@v4
        with:
          path: |
            ~/.bun/install/cache
            .next/cache
          # Cache based on lockfile AND source files
          key: ${{ runner.os }}-nextjs-${{ hashFiles('bun.lockb') }}-${{ hashFiles('**/*.js', '**/*.jsx', '**/*.ts', '**/*.tsx') }}
          # Fallback to cache with same lockfile but different source
          restore-keys: |
            ${{ runner.os }}-nextjs-${{ hashFiles('bun.lockb') }}-

      - name: Build
        run: bun run build

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nextjs-build
          if-no-files-found: error
          path: |
            .next
            public

  # Cypress E2E Tests
  cypress-e2e:
    runs-on: ubuntu-latest
    needs: install
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: nextjs-build
          path: . # Download to current directory (project root)

      - name: Verify build exists
        run: |
          echo "Checking for .next directory..."
          ls -la
          ls -la .next || echo ".next directory not found!"

      - name: Run Cypress E2E tests
        uses: cypress-io/github-action@v6
        with:
          install: false
          start: bun run start
          wait-on: "http://localhost:3000"

  # Cypress Component Tests (commented out for now)
  # cypress-component:
  #   runs-on: ubuntu-latest
  #   needs: install
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest
  #
  #     - name: Install dependencies
  #       run: bun install
  #
  #     - name: Download build artifacts
  #       uses: actions/download-artifact@v4
  #       with:
  #         name: nextjs-build
  #         path: .  # Download to current directory (project root)
  #
  #     - name: Run Cypress Component tests
  #       uses: cypress-io/github-action@v6
  #       with:
  #         install: false
  #         component: true

  # Vitest Unit Tests (commented out - add when ready)
  # vitest:
  #   runs-on: ubuntu-latest
  #   needs: install
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest
  #
  #     - name: Install dependencies
  #       run: bun install
  #
  #     - name: Run Vitest tests
  #       run: bun run test
  #
  #     - name: Upload coverage
  #       uses: codecov/codecov-action@v4
  #       if: always()
  #       with:
  #         files: ./coverage/coverage-final.json

  # Storybook Tests (commented out - add when ready)
  # storybook:
  #   runs-on: ubuntu-latest
  #   needs: install
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest
  #
  #     - name: Install dependencies
  #       run: bun install
  #
  #     - name: Build Storybook
  #       run: bun run build-storybook
  #
  #     - name: Run Storybook tests
  #       run: bun run test-storybook
  #
  #     # Optional: Deploy Storybook to GitHub Pages on main branch
  #     - name: Deploy Storybook
  #       if: github.ref == 'refs/heads/main'
  #       uses: peaceiris/actions-gh-pages@v4
  #       with:
  #         github_token: ${{ secrets.GITHUB_TOKEN }}
  #         publish_dir: ./storybook-static

  # Linting & Type Checking (optional but recommended)
  # lint:
  #   runs-on: ubuntu-latest
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Setup Bun
  #       uses: oven-sh/setup-bun@v2
  #       with:
  #         bun-version: latest
  #
  #     - name: Install dependencies
  #       run: bun install
  #
  #     - name: Run ESLint
  #       run: bun run lint
  #
  #     - name: Run TypeScript check
  #       run: bun run type-check
